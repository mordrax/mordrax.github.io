
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Compile time Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="components.html" />
    
    
    <link rel="prev" href="refactoring.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="prologue.html">
            
                <a href="prologue.html">
            
                    
                    Prologue
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="do-not.html">
            
                <a href="do-not.html">
            
                    
                    Brave new w...holy cow!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="refactoring.html">
            
                <a href="refactoring.html">
            
                    
                    Refactoring
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6" data-path="compile-time.html">
            
                <a href="compile-time.html">
            
                    
                    Compile time
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="components.html">
            
                <a href="components.html">
            
                    
                    Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="file-structure.html">
            
                <a href="file-structure.html">
            
                    
                    File structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="forms.html">
            
                <a href="forms.html">
            
                    
                    Forms
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="endpoints.html">
            
                <a href="endpoints.html">
            
                    
                    Endpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="child-to-parent.html">
            
                <a href="child-to-parent.html">
            
                    
                    Child to Parent/Child/Sibling/First Cousin 2nd removed Communication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="extensible-type-hell.html">
            
                <a href="extensible-type-hell.html">
            
                    
                    Extensible type hell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="lookup.md">
            
                <span>
            
                    
                    Lookup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="final-words.html">
            
                <a href="final-words.html">
            
                    
                    Final words
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="GLOSSARY.md">
            
                <span>
            
                    
                    Glossary
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Compile time</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="compile-time">Compile Time</h1>
<p><em>Coupling, in the form of importing modules, is the key to causing large jumps in compiled files and eventually a blowout in compile time. Anyone who&apos;s experienced their workflow grind to a halt knows what this feels like. elm-module-graph<sup><a href="#fn_elm-module-graph" id="reffn_elm-module-graph">elm-module-graph</a></sup> is an excellent tool in diagnosing where your dependencies come from. Making modules Simple<sup><a href="#fn_simplemadeeasy" id="reffn_simplemadeeasy">simplemadeeasy</a></sup> is the key to having a constant compile time as your application grows.</em></p>
<p>There are two kinds of issues when trying to improve compile time. Compiler/OS optimisation issues<sup><a href="#fn_known-compile-issues" id="reffn_known-compile-issues">known-compile-issues</a></sup> and your application architecture. The former issues are well known and likely to be addressed in the 0.19 release. The latter is the focus of this section as it will affect most codebases beyond ~10k lines. If your application is less than this, or your compile time is under 10 seconds, focus on features and do not waste time fiddling with compile time. Read something useful like <a href="#refactoring">Refactoring</a> to reduce time spent on bugs.</p>
<h4 id="do-you-have-a-coupling-problem">Do you have a coupling problem?</h4>
<p>Here&apos;s the test:</p>
<ol>
<li>Compile your app</li>
<li>Touch a commonly edited module ( a page, a service, model, controller etc... )</li>
<li>How many files recompile?</li>
<li>Repeat this for a few files and get an average.</li>
</ol>
<table>
<thead>
<tr>
<th>Number of Files</th>
<th>Health of your app</th>
</tr>
</thead>
<tbody>
<tr>
<td>3-5</td>
<td>Healthy! Read this section to laugh at my struggles but otherwise you&apos;re wasting time here.</td>
</tr>
<tr>
<td>5-10</td>
<td>You&apos;ve likely already taken some evasive action, 5 is borderline, with 10, there&apos;s a margin to improve but hopefully the compiler will get smarter before your app needs to. There&apos;s not much to gain here.</td>
</tr>
<tr>
<td>10-30</td>
<td>If you&apos;ve just been hacking along without a care, have ~100 files, this is likely where you&apos;re at. If this is a small hobby project, it&apos;s not a big issue. If you&apos;re at work and this is sizeable production code, shit will eventually hit the fan at the velocity you&apos;re going. Stop. Read this section. Improve.</td>
</tr>
<tr>
<td>30+</td>
<td>There is some serious coupling here. The xkcd on compiling<sup><a href="#fn_compiling" id="reffn_compiling">compiling</a></sup> is no longer funny because you&apos;re about to lose your job from lack of productivity.</td>
</tr>
<tr>
<td>100+</td>
<td>Do I even need to welcome you to your own personal hell? Read on. (Seriously though, if this is your average, and this section didn&apos;t help you, I&apos;m happy to help you personally. Hit me up on elm-slack, #compile-time, @mordrax)</td>
</tr>
</tbody>
</table>
<p>So, the above was a bit of <a href="../GLOSSARY.html#fun" class="glossary-term" title="A reference to Dwarf Fortress where &apos;losing is fun&apos;. Much in a similar vein, extensible records can get very confusing very quickly.">fun</a> (need some <a href="../GLOSSARY.html#fun" class="glossary-term" title="A reference to Dwarf Fortress where &apos;losing is fun&apos;. Much in a similar vein, extensible records can get very confusing very quickly.">fun</a> after mashing out 4000 words). The serious point though is that a healthy app should really only be compiling 3-5 files <em>for most changes regardless of the size of the app</em>. This means when you hit 1000 files and 100k LoC, you&apos;re still only compiling 3-5 files. Of course this does not hold for your common files or library files because by definition, they will be imported by alot of modules but more on strategies to mitigate that in <a href="#file-structure">File Structure</a>.</p>
<h4 id="our-story">Our story...</h4>
<p>We had ~350 files in ~30k LoC. <strong>A typical change affected a 65+ files and compiled in ~2 minutes.</strong> This meant adding a Html.div or a Debug.log took 2 minutes each time. This had a <em>HUGE</em> effect on workflow and team morale. We literally stopped working and gave birth to elm-hack (ported a version<sup><a href="#fn_hack" id="reffn_hack">hack</a></sup> to my game), our infamous compile aide. I won&apos;t go into the details there, my talk<sup><a href="#fn_compiletimetalk" id="reffn_compiletimetalk">compiletimetalk</a></sup> with slides<sup><a href="#fn_compiletime" id="reffn_compiletime">compiletime</a></sup> goes into a bit more detail how we were able to get from 2 minutes down to 2 seconds. This bought us enough time to get to a point where management trusted us enough to let me fix the core issue.
Fast forward 3 months, and a complete re-architect of the root modules, we&apos;re now at ~45k LoC in 426 files. A typical change will affect 3-4 files and take 15-30 secs.</p>
<p><em>(Aside: &quot;Complete re-architect&quot; sounds scarrrry, ooohhhhh, a COMPLETE re-architect, aaarrrhhhh. But we&apos;re in Elm. And I had done all the refactorings I mentioned in the refactoring section. I spent 2-3 days to do some major 1-2k lines of reshuffling of modules. Then I spent the rest of the week and another 3-4k lines to rewrite routing, page loading, port existing pages over. One week. Not the end of the world. Had about ~15 bugs, I only remember 3 but I don&apos;t think anyone would believe me if I said that after rewriting 5k LoC, I had three bugs. I remember these bugs because they still had impossible state. That&apos;s the only thing that breaks. reliably. every. time.)</em></p>
<h4 id="case-study--quotes-">Case study ( Quotes )</h4>
<p>To explain why coupling is bad for compile time, I&apos;m going to use a work related example.
In health insurance, there is a concept of <em>Person</em>, these people take up a either a single, couple or family <em>Membership</em>.</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Person.elm</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Person</span> =</span>
{ id : <span class="hljs-type">Int</span>
, <span class="hljs-comment">-- more fields</span>
}

<span class="hljs-comment">-- Membership.elm</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Membership</span> =</span>
{ id : <span class="hljs-type">Int</span>
, <span class="hljs-comment">-- more fields</span>
}
</code></pre>
<p>There is a large list of pages which handle various aspects of both:</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Medicare.elm</span>
<span class="hljs-keyword">import</span> Person exposing (<span class="hljs-type">Person</span>)

<span class="hljs-comment">-- ClearanceCertificate.elm</span>
<span class="hljs-keyword">import</span> Person exposing (<span class="hljs-type">Person</span>)

<span class="hljs-comment">-- Rebates.elm</span>
<span class="hljs-keyword">import</span> Membership exposing (<span class="hljs-type">Membership</span>)

<span class="hljs-comment">-- etc...</span>
</code></pre>
<p>A feature of insurance is we get a quote for a single person or a membership.</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Quote.elm</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">QuoteID</span></span>
= <span class="hljs-type">PersonID</span> <span class="hljs-type">Int</span>
| <span class="hljs-type">MembershipId</span> <span class="hljs-type">Int</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Quote</span> =</span>
{ id : <span class="hljs-type">QuoteId</span>
, <span class="hljs-comment">-- more fields...</span>
}
</code></pre>
<p>Now, since one can make a quote in Person or Membership, it makes sense to add it to the respective models.</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Person.elm</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Person</span> =</span>
{ id : <span class="hljs-type">Int</span>
, quote: <span class="hljs-type">Quote</span>
, ...
}

<span class="hljs-comment">-- Membership.elm</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">MemberPolicy</span> =</span>
{ id : <span class="hljs-type">Int</span>
, quote: <span class="hljs-type">Quote</span>
, ...
}
</code></pre>
<p>Visually this looks like the following:</p>
<p><img src="https://preview.ibb.co/mWjMfx/Screen_Shot_2018_03_02_at_9_10_56_pm.png" alt="abc"></p>
<p>Great, we&apos;ve got some code sharing here. Both Person and Membership now share the Quote component and we&apos;re happy! ( Of course, the avid reader would know that&apos;s not how the story goes.)</p>
<pre><code class="lang-haskell"><span class="hljs-title">touch</span> <span class="hljs-type">Quotes</span>.elm
<span class="hljs-title">elm</span>-make ...
<span class="hljs-type">Compiling</span> <span class="hljs-number">33</span> modules
</code></pre>
<p>According to my highly accurate &apos;Do you have a Coupling problem?&apos; chart, we ranked (30+):</p>
<blockquote>
<p>There is some serious coupling here. The xkcd on compiling<a href="https://stackedit.io/app#fn7" target="_blank">7</a> is no longer funny because you&#x2019;re about to lose your job from lack of productivity.</p>
</blockquote>
<p>So we had a common component, it was added to the model where it was needed most, then the view and update logic are shared. <em>What&apos;s the problem?</em></p>
<p>Here&apos;s some food for thought:</p>
<pre><code>touch Person/Page1.elm
elm-make ...
Compiling 1 module

touch Membership/Page15.elm
elm-make ...
Compiling 1 module

touch Membership/Model.elm
elm-make ...
Compiling 15 modules
</code></pre><p><strong>When you touch a module (Quote.elm), it will re-compile <em>ALL</em> modules (all pages, person/membership models) that directly or indirectly import the changed module.</strong></p>
<p>When does it not do this?</p>
<p>Myth #1: If I change a non-exposed function in Quotes.elm it will not re-compile all modules that import it.</p>
<p>Myth #2: If I make my Quote type opaque and only export the opaque type, it will not re-compile all modules that import it.</p>
<p>Myth #3: If I add a comment to Quotes.elm, it will not re-compile all modules that import it.</p>
<p>Fact: Doing anything to Quotes.elm will re-compile all modules that import it.</p>
<p>This is the reason for all non-compiler/OS related compile time blowouts and it can happen very quickly, just with the introduction of one feature, badly coupled.</p>
<p>There is an excellent tool for looking at this specific scenario of coupling in your app, elm-module-graph<sup><a href="#fn_elm-module-graph" id="reffn_elm-module-graph">elm-module-graph</a></sup>. And for the case study, it produces the following graph:</p>
<p><img src="https://preview.ibb.co/jNG3Sc/Screen_Shot_2018_03_02_at_9_30_51_pm.png" alt="elm module graph demonstrating coupling"></p>
<p>So Quotes is the highlighted module. It has 11 blue modules lit up, these are the modules that either import it directly or indirectly. There are 3 black lines that comes out of quotes, these are the modules that import Quotes directly. The rest of them come out of Model.Person because Model.Person imports Quotes.</p>
<p>This is how it looked after I <em>removed Quotes from the Person/Membership</em> models and passed it into functions that required it.</p>
<p><img src="https://image.ibb.co/djq2Lx/Screen_Shot_2018_03_02_at_9_36_22_pm.png" alt="Refactored version of quotes"></p>
<p>So now Quotes is directly imported by Membership and Person, two <a href="../GLOSSARY.html#tea" class="glossary-term" title="A module that has init, update and view, wired up to Main in a nested fashion">TEA</a> modules and this is imported by Main.</p>
<pre><code class="lang-haskell"><span class="hljs-title">touch</span> <span class="hljs-type">Quotes</span>.elm
<span class="hljs-title">elm</span>-make ...
<span class="hljs-type">Compiling</span> <span class="hljs-number">4</span> modules
</code></pre>
<p>Let&apos;s count that, Quotes, Membership, Person, Main. <em>Four</em>!</p>
<blockquote>
<p>Healthy! Read this section to laugh at my struggles but otherwise you&apos;re wasting time here.</p>
</blockquote>
<p>So with this pattern, even if your app reaches 426 files, your compile time will not grow with it.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="refactoring.html" class="navigation navigation-prev " aria-label="Previous page: Refactoring">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="components.html" class="navigation navigation-next " aria-label="Next page: Components">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Compile time","level":"1.6","depth":1,"next":{"title":"Components","level":"1.7","depth":1,"path":"chapters/components.md","ref":"chapters/components.md","articles":[]},"previous":{"title":"Refactoring","level":"1.5","depth":1,"path":"chapters/refactoring.md","ref":"chapters/refactoring.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapters/compile-time.md","mtime":"2018-03-27T11:32:57.477Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-27T11:27:00.243Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

