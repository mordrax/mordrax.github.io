
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Brave new w...holy cow! Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="refactoring.html" />
    
    
    <link rel="prev" href="prologue.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="prologue.html">
            
                <a href="prologue.html">
            
                    
                    Prologue
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="do-not.html">
            
                <a href="do-not.html">
            
                    
                    Brave new w...holy cow!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="refactoring.html">
            
                <a href="refactoring.html">
            
                    
                    Refactoring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="compile-time.html">
            
                <a href="compile-time.html">
            
                    
                    Compile time
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="components.html">
            
                <a href="components.html">
            
                    
                    Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="file-structure.html">
            
                <a href="file-structure.html">
            
                    
                    File structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="forms.html">
            
                <a href="forms.html">
            
                    
                    Forms
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="endpoints.html">
            
                <a href="endpoints.html">
            
                    
                    Endpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="child-to-parent.html">
            
                <a href="child-to-parent.html">
            
                    
                    Child to Parent/Child/Sibling/First Cousin 2nd removed Communication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="extensible-type-hell.html">
            
                <a href="extensible-type-hell.html">
            
                    
                    Extensible type hell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="lookup.md">
            
                <span>
            
                    
                    Lookup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="final-words.html">
            
                <a href="final-words.html">
            
                    
                    Final words
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="GLOSSARY.md">
            
                <span>
            
                    
                    Glossary
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Brave new w...holy cow!</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="brave-new-wholy-cow">Brave New W..holy cow!</h1>
<p><em>The first week on the job was challenging for me. It was the first time working with Elm professionally and the code I saw there was, to put it lightly, extremely horribly bad. I describe major flaws in the design and explain why they are bad.</em></p>
<blockquote>
<p>You can choose to ignore ADTs, couple modules by their Msg or Model types, write imperatively, carelessly create impossible state, type everything as strings, name functions completely different to what they do, introduce Maybes everywhere and the compiler will not save you.</p>
</blockquote>
<p>The first thing I did was to add elm-format<sup><a href="#fn_elm-format" id="reffn_elm-format">elm-format</a></sup>. Elmformatslikeaddingpunctuationspacesandcommastoasentence.</p>
<h4 id="global-msg-coupling">Global Msg coupling</h4>
<p>The root level Msg.elm appeared as an import in 74 files. In many cases, this was <code>import Msg exposing (Msg(..))</code></p>
<p>Since modules nested many levels deep returned the root level Msg, each of these modules mapped their msg to the global <code>Msg</code> all the way down and ended up constructing the global <code>Msg</code> like these:</p>
<pre><code class="lang-haskell"><span class="hljs-title">fieldTag</span> : <span class="hljs-type">Tagger</span> <span class="hljs-type">PersonPanelMsg</span> -&gt; <span class="hljs-type">String</span> -&gt; (<span class="hljs-type">String</span> -&gt; <span class="hljs-type">Msg</span>)
<span class="hljs-title">fieldTag</span> tagger fieldName =
(\val -&gt; tagger &lt;| <span class="hljs-type">OverlayPanelMsg_</span> &lt;| <span class="hljs-type">EditPersonMsg_</span> &lt;| <span class="hljs-type">SetPersonField</span> ( fieldName, val ))


<span class="hljs-title">clickTag</span> : <span class="hljs-type">Tagger</span> <span class="hljs-type">PersonPanelMsg</span> -&gt; <span class="hljs-type">String</span> -&gt; <span class="hljs-type">String</span> -&gt; <span class="hljs-type">Msg</span>
<span class="hljs-title">clickTag</span> tagger fieldName val =
<span class="hljs-title">tagger</span> &lt;| <span class="hljs-type">OverlayPanelMsg_</span> &lt;| <span class="hljs-type">EditPersonMsg_</span> &lt;| <span class="hljs-type">SetPersonField</span> ( fieldName, val )
</code></pre>
<p>In any module where this happens, it coupled that module to the global <code>Msg</code> type. Any change in <code>Msg</code> could potentially affect all modules that import it and thus caused all these modules to recompile.</p>
<h4 id="magic-numbers-everywhere">Magic numbers everywhere</h4>
<p>In a language with ADTs, where the compiler is able to prove the correct usage of these ADTs, it makes <em>absolutely no sense</em> to represent a finite set of options with an infinite set of Int or even worse, Strings.</p>
<pre><code class="lang-haskell"><span class="hljs-title">if</span> val == <span class="hljs-string">&quot;0&quot;</span> <span class="hljs-keyword">then</span> ...

<span class="hljs-title">case</span> panel.tabIndex <span class="hljs-keyword">of</span>
<span class="hljs-number">7</span> -&gt;
<span class="hljs-number">6</span> -&gt;
<span class="hljs-title">_</span> -&gt;

<span class="hljs-title">case</span> formType <span class="hljs-keyword">of</span>
<span class="hljs-string">&quot;L...&quot;</span> -&gt;
<span class="hljs-string">&quot;M...&quot;</span> -&gt;
<span class="hljs-title">_</span> -&gt;
</code></pre>
<p>This is something you might do in javascript. In fact, you are forced to because there is no other way, Javascript (and other languages like C#, Java, Ruby) only have primitive types. The compiler is unable to check whether all paths through the program is accounted for. ADTs in Elm are a core ingredient to reducing regression bugs because it allows the compiler to check the application for correctness.</p>
<h4 id="msg-model-parent-coupling">Msg, Model, Parent coupling</h4>
<p>So on first inspection, the following function updates the overlay pane. All good, carry on.</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- src/Elixir/Person/Update.elm</span>
<span class="hljs-title">updateOverlayPane</span> :
<span class="hljs-type">PersonTagger</span> -&gt;
<span class="hljs-type">PersonOverlayMsg</span> -&gt;
<span class="hljs-type">Model</span> -&gt;
( <span class="hljs-type">WBPanel</span>, <span class="hljs-type">UIPersonPanelModel</span> ) -&gt;
( <span class="hljs-type">WBPanel</span>, <span class="hljs-type">Cmd</span> <span class="hljs-type">Msg</span> )
</code></pre>
<p>err.. hang on, what are the two models <code>Model</code> and <code>UIPersonPanelModel</code> doing. Shouldn&apos;t we take in one model and return the updated version?</p>
<p>Well, it turns out, actually, that there are <em>three</em> models in this module.</p>
<pre><code class="lang-haskell"><span class="hljs-title">updateOverlayPane</span> :
<span class="hljs-type">PersonTagger</span> -&gt;
<span class="hljs-type">PersonOverlayMsg</span> -&gt;
<span class="hljs-type">Model</span> -&gt; <span class="hljs-comment">-- Global model</span>
( <span class="hljs-type">WBPanel</span>, <span class="hljs-type">UIPersonPanelModel</span> ) -&gt; <span class="hljs-comment">-- (Parent model, Own model)</span>
( <span class="hljs-type">WBPanel</span>, <span class="hljs-type">Cmd</span> <span class="hljs-type">Msg</span> ) <span class="hljs-comment">-- Global msg</span>
</code></pre>
<p>It turns out this function updates this module&apos;s model <code>UIPersonPanelModel</code>, then takes the parent model (<code>WBPanel</code>), updates that too, then constructs a global level <code>Msg</code> because it has complete visibility of that type through the <code>exposing (Msg(..))</code>.</p>
<p>By coupling these three models in the one module, it made it much harder for me to understand what this function does because I have to understand what the parent does, and what the root does as they are all related. If only Elm would enforce purity of scope as well as purity of functions. ( hint: Opaque types )</p>
<p><em>Aside: Much later on, I looked back on this and realised this was possibly their way of trying get child to parent communication working. At the time, it was really... really... scary.</em></p>
<h4 id="maybe-ids-and-the-ticking-time-bomb">Maybe ids and the ticking time bomb</h4>
<pre><code class="lang-haskell"><span class="hljs-comment">-- this sort of code...</span>

<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Person</span> =</span>
{ personId : <span class="hljs-type">Maybe</span> <span class="hljs-type">Int</span>
}

<span class="hljs-comment">-- lead to these hacks</span>

<span class="hljs-title">pid</span> = <span class="hljs-type">Maybe</span>.withDefault personId <span class="hljs-number">0</span>
<span class="hljs-title">personId</span> = <span class="hljs-type">Maybe</span>.withDefault uiModel.number <span class="hljs-number">0</span>
<span class="hljs-title">id</span> = <span class="hljs-type">Maybe</span>.withDefault myId <span class="hljs-number">0</span>
</code></pre>
<p>So what&apos;s happening is that the backend is returning a <code>Maybe Int</code> for a person id. Then the frontend handles it by using 0 as a default whenever it encounters Nothing <em>reasoning that it&apos;ll never happen</em>.</p>
<p>What this does is basically:</p>
<pre><code class="lang-haskelljs">try {
// get person id
// do something with it
} catch () {
// swallow error, suckers...
}
</code></pre>
<p>(<em>Aside: Backend recently stopped doing this. Now I&apos;ll sleep well again.</em>)</p>
<p>The point is, never use a Maybe for something that should never be null. Coming from js, <em>everything</em> could be undefined or null... you poor sods. In a typed functional language, Maybes are rare because for most functions, you actually don&apos;t want it&apos;s arguments to be null. e.g: <code>add: Maybe Int -&gt; Maybe Int -&gt; Maybe Int</code></p>
<h4 id="impossible-states">Impossible states</h4>
<p>Things like the following example are common.</p>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Form</span> = { ...
, <span class="hljs-title">verified</span> : <span class="hljs-type">Bool</span> <span class="hljs-comment">-- has the form been verified</span>
, <span class="hljs-title">message</span> : <span class="hljs-type">String</span> <span class="hljs-comment">-- verification error message</span>
}</span>

<span class="hljs-comment">-- used like</span>
<span class="hljs-title">if</span> fm.verified <span class="hljs-keyword">then</span>
<span class="hljs-title">div</span> [] [ text (fm.message) ]
</code></pre>
<p>So what happens when verified is true and there is an error message? Or if it&apos;s false and there is no message? Or what do those two fields even have in common?
Here&apos;s how I would do it.</p>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">VerificationStatus</span></span>
= <span class="hljs-type">NotVerified</span>
| <span class="hljs-type">Error</span> <span class="hljs-type">String</span>
| <span class="hljs-type">Success</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> alias <span class="hljs-type">Form</span> = {
<span class="hljs-title">verificationStatus</span> : <span class="hljs-type">VerificationStatus</span>
}</span>
</code></pre>
<p>The type documents the intent + represents <em>exactly</em> the states we want and now the compiler will help us if any of those cases are not handled either now or next year.</p>
<p>And so at the end of the first day, I was left wondering how to even start working on this project. To put it bluntly, this might as well have been written in javascript. At least you have a <code>try...catch</code> wrapper there for exceptions, here, most cases had a <code>_ -&gt; ...</code> to swallow up all exceptions.</p>
<ul>
<li>[<a href="../GLOSSARY.html#adt" class="glossary-term" title="Algebraic Data Type">ADT</a>]: Algebraic data types</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="prologue.html" class="navigation navigation-prev " aria-label="Previous page: Prologue">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="refactoring.html" class="navigation navigation-next " aria-label="Next page: Refactoring">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Brave new w...holy cow!","level":"1.4","depth":1,"next":{"title":"Refactoring","level":"1.5","depth":1,"path":"chapters/refactoring.md","ref":"chapters/refactoring.md","articles":[]},"previous":{"title":"Prologue","level":"1.3","depth":1,"path":"chapters/prologue.md","ref":"chapters/prologue.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapters/do-not.md","mtime":"2018-03-27T11:33:30.013Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-27T11:27:00.243Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

